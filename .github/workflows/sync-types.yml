name: Sync thrift changes to types repository

on:
  push:
    branches:
      - dev-github-build-action
    # paths:
    #   - "thrift/**"
    #   - "thrift_build.ps1"
    #   - "thrift_build.sh"
# jobs:
#   sync:
#     runs-on: self-hosted
#     steps:
#       - name: Checkout source repository
#         uses: actions/checkout@v3
#         with:
#           ref: dev

#       - name: Setup git config
#         run: |
#           git config --global user.name "LLM Inference GitHub Actions"
#           git config --global user.email "llm-inference-actions@github.com"

#       - name: Sync to target repository
#         uses: ad-m/github-push-action@v0.8.0
#         with:
#           github_token: ${{ secrets.TYPES_REPO_TOKEN }}
#           # repository: alexandriaproject-io/alexandria-project-types
#           repository: SergeSyntax/test-github-ci-cd-sync
#           branch: dev
#           force: true
#           directory: thrift
jobs:
  build-and-push:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.TYPES_REPO_TOKEN }}

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.TYPES_REPO_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install Dependencies
        run: npm install

      - name: Build Project
        run: npm run build

      - name: Commit and Push Build
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -f build/
          git commit -m "Automated build commit"
          git tag -a "v$(date +'%Y%m%d%H%M%S')" -m "Automated build tag"
          git push origin HEAD:main --tags
